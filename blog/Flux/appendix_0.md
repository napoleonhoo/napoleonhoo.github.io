# 从0到1谈机器学习完整流程搭建（离线训练篇）

离线训练的以fs的落的日志作为起点，以cube配送到predictor作为终点，行成闭环，循环往复。训练作为最重要的一环，但却不是唯一的一环。

## 1 拼接

机器学习离线训练的最开始，是拼接。拼接就是指将用户请求数据与用户行为数据拼接到一起的过程。

- 输入：fs落的用户请求日志，用户行为日志。

- 输出：给下游的sample

- 过程：从线上服务fs（feature-service，特征服务）获取用户的请求日志、行为日志，利用如request_id（请求ID）、nid（文章ID）、uid（用户ID）等唯一信息，将用户的请求与行为拼接在一起。获得一个统一格式（由PB定义）的sample，写入下游（AFS、bigpipe）。备注：这里请求日志指的是gr请求predictor的日志，亦称为gr.log。

- 备注：拼接分为流式与MR。



## 2 抽取

机器学习离线训练的第二步，就是抽取。抽取就是将拼接产出的sample，抽取为一种便于模型处理的格式，即feasign，也可称为（模型用的）样本。

- 输入：拼接产出的sample。
- 输出：给下游的feasign，写afs，供给模型训练。
- 过程：sample按uid+nid粒度，对需要的字段，产出一条样本。
- 备注：抽取分为流式与MR。

## 3 训练

机器学习离线训练的第三步，就是训练本身。训练就是将数据样本（feasign）输入网络结构中，产出可配送到线上的xbox。

- 输入：feasign
- 输出：给cube的模型参数（实际上还应包括网络结构）
- 过程：样本输入网络，利用参数，更新参数，产出新的参数。
- 备注：网络结构是直接配置在predictor上的。



## 4 配送

机器学习离线训练的第四步，就是将产出的xbox模型利用cube配送到线上，供predictor使用。

- 输入：afs上的xbox数据
- 输出：可以认为没有
- 过程：cube可以认为是一个存储数据库，衔接了在离线的桥梁。
- 备注：也分流式和MR。



备注：涉及到粗排又有一些不同，doc侧sample、样本、训练（离线预估infer）、配送也同样是一套完整的流程。
